---
title: BitsAI-CRé˜…è¯»æŠ¥å‘Š
date: 2025-02-06 15:30:07
tags:
 - ç”Ÿæˆå¼AI
 - LLM
---

# è®ºæ–‡

BitsAI-CR: Automated Code Review via LLM in Practice

[https://arxiv.org/abs/2501.15134](https://arxiv.org/abs/2501.15134)

# å…³é”®ç‚¹

## è§„åˆ™

1. AI reviewèƒ½å‘ç°çš„é—®é¢˜æ˜¯å›ºå®šçš„ï¼Œå¯¹åº”è§„åˆ™ï¼Œå¹¶ä¸”æŒ‰ç…§é¢†åŸŸã€ç±»åˆ«è¿›è¡Œç»„ç»‡
2. æ–°å¢è§„åˆ™å®é™…ä¸Šæ˜¯é‡æ–°è®­ç»ƒLoraæ¨¡å‹
3. é€šè¿‡å®éªŒè¯æ˜äº†åˆ†ç±»åçš„è§„åˆ™è®­ç»ƒçš„æ¨¡å‹æœ‰æ•ˆæ€§æ›´é«˜

## æµç¨‹

1. æå‡ºäº†RuleChecker - RuleFilter - Aggregator çš„3é˜¶æ®µæµç¨‹
2. Checkerå’ŒFilterå‡è®­ç»ƒäº†Loraæ¨¡å‹ï¼ŒAggregatorä½¿ç”¨embeddingç›¸ä¼¼åº¦åˆå¹¶é—®é¢˜
3. é€šè¿‡å®éªŒè¯æ˜äº†Filterèƒ½å¤Ÿé™ä½å¹»è§‰é—®é¢˜ï¼Œæé«˜ç²¾ç¡®åº¦
4. é€šè¿‡å®éªŒè¯æ˜äº†Conclusion Firstçš„Filter æ¨ç†å½¢å¼ç²¾ç¡®ç‡æœ€é«˜

## æŒ‡æ ‡

1. ç²¾ç¡®ç‡ï¼ŒPrecisionæ¯”Recallæ›´é‡è¦
2. Outdated Rate: ç›¸å½“äºä¿®å¤ç‡ï¼Œé—®é¢˜çš„ä»£ç æœ‰æ²¡æœ‰è¢«ä¿®æ”¹è¿‡

## æŒç»­è¿­ä»£

1. æ–°å¢è§„åˆ™ï¼šæ¥è‡ªé™æ€åˆ†æçš„è§„åˆ™ + äººå·¥Reviewçš„è¯„è®º
2. åœ¨çº¿åé¦ˆè¿­ä»£ï¼šç”¨æˆ·åé¦ˆ + æ‰‹åŠ¨æ ‡æ³¨ + ç›‘æ§çœ‹æ¿
3. æŒ‡æ ‡çš„è¶‹åŠ¿çœ‹æ¿ + é—®å·è°ƒæŸ¥å’Œä¸“å®¶è®¿è°ˆ

ç–‘é—®ï¼š

1. AIè¾“å‡ºçš„æ˜¯å•è¡Œï¼Œå¤šè¡Œé—®é¢˜æ€ä¹ˆè¯„æµ‹ï¼Ÿ

# å¯å‘

1. å¼•å…¥äºŒé˜¶æ®µRuleFilterï¼Œå’Œä¸‰é˜¶æ®µAggregator
2. éœ€è¦æŒç»­åœ°æŠ•å…¥æ ‡æ³¨æ•°æ®ã€è®¾è®¡å®éªŒã€è¯„æµ‹ç»“æœ
3. å¯¹äºæ–°å¢ä¸šåŠ¡è§„åˆ™ï¼Œè®­Loraä¹Ÿæ˜¯ä¸€ç§æ–¹æ³•ï¼ˆå¦ä¸€ç§æ–¹æ³•æ˜¯RAGï¼‰
4. Precisionå’ŒOutdated Rateä½œä¸ºå…³é”®æŒ‡æ ‡
5. æŒç»­è¿­ä»£ä¾èµ–å¤§é‡äººå·¥æ ‡æ³¨ï¼Œæ€»å¾—æœ‰äººæ ‡æ•°æ®

# æ•ˆæœ

```
Empiri-
cal evaluation demonstrates BitsAI-CRâ€™s effectiveness, achieving
75.0% precision in review comment generation. For the Go language
which has predominant usage at ByteDance, we maintain an Out-
dated Rate of 26.7%.
```

# 3. æ–¹æ³•è®º

## 3.1 æ¶æ„

![framework](/img/2025/bitsai-cr/framework.png)

## 3.2 è§„åˆ™å‡†å¤‡

219æ¡è§„åˆ™ã€‚æŒ‰ç…§Dimensions - Categories - Rules 3å±‚è¿›è¡Œç»„ç»‡ã€‚

![rule](/img/2025/bitsai-cr/rule.png)

## 3.3 å®Œæ•´çš„Pipeline

### Context Preparation

1. å°†code diffåˆ‡åˆ†ä¸ºhunksï¼Œé¿å…è¶…è¿‡ä¸Šä¸‹æ–‡é•¿åº¦
2. ä½¿ç”¨tree-sitterå°†æ¯ä¸ªcode blockæ‹“å±•åˆ°å®Œæ•´çš„å‡½æ•°å®šä¹‰
3. å¢åŠ æ ‡æ³¨ï¼š[deleted or pre-modified @line_number in old code] or [added or post-modified @line_number in new code]

### RuleChecker

![rulechecker](/img/2025/bitsai-cr/rulechecker.png)

### ReviewFilter

äºŒåˆ†ç±»è¿‡æ»¤ã€‚3ç§ä¸åŒçš„æ¨ç†æ¨¡å¼ï¼š

1. Direct conclusion
2. Reasoning-First, COT
3. Conclusion-First

### Comment Aggregation

ä½¿ç”¨embedding modelå¯¹ç›¸ä¼¼é—®é¢˜è¿›è¡Œèšåˆ

## 3.4 æŒ‡æ ‡è¯„ä¼°

### ç²¾ç¡®ç‡

é‡è§†ç²¾ç¡®åº¦ > å¬å›ç‡ï¼Œå› æ­¤ä½¿ç”¨ç²¾ç¡®ç‡æŒ‡æ ‡ã€‚

```
Formally, let ğ¶ğ‘ğ‘œğ‘Ÿğ‘Ÿğ‘’ğ‘ğ‘¡ represent the set of correct com-
ments and ğ¶ğ‘¡ğ‘œğ‘¡ğ‘ğ‘™ represent all comments generated by BitsAI-CR,
```

### Outdated Rate

å°±æ˜¯ä¿®å¤ç‡  Outdated Rate for Automated Evaluation

```
ğ¶ğ‘ ğ‘’ğ‘’ğ‘› represents the set of comments reviewed by code com-
mitters within a one-week measurement window, and the function
isOutdated (ğ‘) returns true only if a comment ğ‘ is considered out-
dated, which occurs when if any line within its flagged code range
is modified in subsequent commits.
```

### 3.5 æ•°æ®é£è½®ï¼šæŒç»­è¿›åŒ–

æ–°è§„åˆ™æ¥æº

1. å†…éƒ¨é™æ€åˆ†æè§„åˆ™
2. äººå·¥Reviewçš„è¯„è®º

å°†è§„åˆ™è¿›è¡Œæ•´ç†ã€é‡‡æ ·åï¼Œè®­ç»ƒæ–°çš„æ¨¡å‹

åœ¨çº¿åé¦ˆè¿­ä»£

1. ç”¨æˆ·åé¦ˆæ”¶é›†
2. æ‰‹åŠ¨è¿›è¡Œè§„åˆ™çš„Precisioné‡‡æ ·ï¼Œäººå·¥æ ‡æ³¨
3. ç›‘æ§Outdated Rate

ç»¼åˆæŒ‡æ ‡ï¼Œå†³å®šæ˜¯æ–°å¢è¿˜æ˜¯ç§»é™¤è§„åˆ™

```
Rules are assessed based on specific criteria: an Outdated Rate of around 25% (Â±5%) with a precision of around 65% (Â±5%) for 14 days
```

### 3.6 å®æ–½

è·Ÿgitlabé›†æˆã€‚å½“é—®é¢˜è¢«ä¿®å¤åï¼Œè¯„è®ºLGTM

![gitlab](/img/2025/bitsai-cr/gitlab.png)

# 4 å®éªŒ

## 4.1 æ¨¡å‹è®­ç»ƒ

åŸºäºdoubaoè®­ç»ƒçš„2ä¸ªLoraæ¨¡å‹ï¼šRuleChecker å’Œ ReviewFilter

## 4.2 ç¦»çº¿è¯„ä¼°

æµ‹è¯•æ•°æ®é›†

```
To evaluate BitsAI-CRâ€™s effectiveness in code review, we collect an
offline dataset consisting of 1397 cases sampled from the production
codebase, where 767 samples violate and 630 samples follow the
code best practices.
```

æ¯”è¾ƒæ–¹æ³•

```
The review comment is deemed correct only if the model determines it aligns with the ground truth. 
```

å®éªŒäº†2ä¸ªç‰ˆæœ¬çš„æ¨¡å‹

1. BitsAI-CR w/o Taxonomy  57.03%
2. BitsAI-CR   16.83%

æ¶ˆèå®éªŒï¼šè¯æ˜RuleFilteræ˜¯æœ‰ç”¨çš„

Reason Patterns of ReviewFilter

ä½¿ç”¨Conclusion Firstçš„æ–¹å¼Pæœ€é«˜ï¼ŒRæœ€ä½ï¼ŒFilter Rateæœ€é«˜

æ›´å…³æ³¨Pï¼Œå› æ­¤ä½¿ç”¨Conclusion Firstå½¢å¼

![result](/img/2025/bitsai-cr/result.png)

### 4.3 åœ¨çº¿è¯„ä¼°

Precisionå’ŒOutdate rateçš„æ¯å‘¨è¿›å±•

å®šé‡åˆ†æï¼šé—®å·è°ƒæŸ¥+ä¸“å®¶è®¿è°ˆ

# 5 å…³é”®Insight

1. Taxonomy of Review Rules it enables systematic code issue categorization, data collection, and performance evaluation.
2. Two-Stage Review Generation i enhances automated code review reliability by validating identified issues.
3. Precision and Outdated Rate Metrics it guides data flywheel optimization through user-centric evaluation.
